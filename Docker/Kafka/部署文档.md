## Kafka3（Raft）单机部署

### 生成集群ID
```bash
生成集群 ID
bin/kafka-storage.sh random-uuid
1kwB-zWkQfmc7Lc9wMuiLQ
```

### 单机部署
```bash
docker run --cpus 1 -m 1g -d -p 9093:9093 -v /tmp/kraft-combined-logs:/tmp/kraft-combined-logs --name kafka-raft-3.0.0 kubebiz/kafka:2.13-3.0.0 /bin/bash -c "kafka-storage.sh format --ignore-formatted --cluster-id 1kwB-zWkQfmc7Lc9wMuiLQ --config /opt/kafka/config/kraft/server.properties && exec kafka-server-start.sh /opt/kafka/config/kraft/server.properties"
```

### 单机压测
```bash
# 进入容器
docker exec -it containerid /bin/bash
# 进入kafka目录
cd /opt/kafka_2.13-3.0.0
# 生产者压测
root@cc1e321a6c82:/opt/kafka_2.13-3.0.0# kafka-producer-perf-test.sh  --topic test --record-size 200 --num-records 10000 --throughput -1 --producer-props bootstrap.servers=localhost:9092
10000 records sent, 7770.007770 records/sec (1.48 MB/sec), 120.23 ms avg latency, 589.00 ms max latency, 103 ms 50th, 193 ms 95th, 194 ms 99th, 195 ms 99.9th.
root@cc1e321a6c82:/opt/kafka_2.13-3.0.0# kafka-producer-perf-test.sh  --topic test --record-size 200 --num-records 10000 --throughput -1 --producer-props bootstrap.servers=localhost:9092
10000 records sent, 6253.908693 records/sec (1.19 MB/sec), 133.00 ms avg latency, 509.00 ms max latency, 107 ms 50th, 286 ms 95th, 312 ms 99th, 314 ms 99.9th.
# 消费者压测
root@cc1e321a6c82:/opt/kafka_2.13-3.0.0# bin/kafka-consumer-perf-test.sh --broker-list localhost:9092, --topic test --fetch-size 10000 --messages 10000000
start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec
WARNING: Exiting before consuming the expected number of messages: timeout (10000 ms) exceeded. You can use the --timeout option to increase the timeout.
2022-10-26 07:23:01:519, 2022-10-26 07:24:08:665, 1096.1761, 16.3253, 1144712, 17048.1041, 4610, 62536, 17.5287, 18304.8484
```


### 集群测试

进入容器
```bash
docker exec -it kafka1 /bin/bash
```
创建Topic（副本3、分区5）：
```bash
./opt/kafka_2.13-2.8.1/bin/kafka-topics.sh --create --zookeeper 172.26.114.212:2181 --replication-factor 2 --partitions 5 --topic TestTopic
```

查看Topic：
```bash
./opt/kafka_2.13-2.8.1/bin/kafka-topics.sh --describe --zookeeper 172.26.114.212:2181 --topic TestTopic
```

> 5个分区分散到两个节点。

登录其它节点查看Topic是否同步。

节点1运行生产者：
```bash
./opt/kafka_2.13-2.8.1/bin/kafka-console-producer.sh --broker-list 172.26.114.212:9092 --topic TestTopic
```
节点2运行消费者：
```bash
./opt/kafka_2.13-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server 172.16.0.119:9092 --topic TestTopic --from-beginning
```
